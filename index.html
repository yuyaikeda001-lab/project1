<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高田保馬 AI対話システム</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
/* 全体の設定 */
html, body {
    margin: 0;
    padding: 0;
    height: 100%;
    font-family: 'Noto Serif JP', 'Merriweather', serif;
    background: linear-gradient(135deg, rgba(10,10,15,0.95), rgba(25,25,40,0.95)),
                url('https://images.unsplash.com/photo-1529070538774-1843cb3265df?auto=format&fit=crop&w=1920&q=80');
    background-size: cover;
    background-attachment: fixed;
    background-position: center;
    color: #e0e0e0;
    display: flex;
    justify-content: center;
    align-items: center;
}

/* コンテナ全体 */
.chat-container {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
    max-width: 900px;
    background: rgba(20, 20, 25, 0.65);
    border: 1px solid rgba(210, 190, 120, 0.4);
    border-radius: 0;
    box-shadow: 0 0 25px rgba(0,0,0,0.5);
    backdrop-filter: blur(10px);
    overflow: hidden;
}

/* ヘッダー */
.chat-header {
    background: linear-gradient(90deg, rgba(160,120,50,0.85), rgba(80,60,30,0.7));
    color: #fffdf4;
    padding: 12px;
    text-align: center;
    font-size: 1.1em;
    font-weight: 700;
    letter-spacing: 1px;
    border-bottom: 1px solid rgba(255,255,255,0.1);
    text-shadow: 0 0 6px rgba(255,215,140,0.4);
    flex-shrink: 0;
}

/* メッセージエリア */
.chat-messages {
    flex-grow: 1;
    padding: 12px 10px;
    overflow-y: auto;
    background: radial-gradient(circle at bottom right, rgba(255,255,255,0.04), transparent 70%);
}

/* 吹き出し構造 */
.message {
    display: flex;
    align-items: flex-start;
    margin-bottom: 10px;
    word-wrap: break-word;
}

.avatar {
    width: 34px;
    height: 34px;
    border-radius: 50%;
    background: linear-gradient(135deg, #a87932, #c49a4d);
    color: white;
    font-weight: bold;
    display: flex;
    justify-content: center;
    align-items: center;
    margin: 0 6px;
    flex-shrink: 0;
}

.message-bubble {
    max-width: 75%;
    padding: 10px 14px;
    border-radius: 16px;
    line-height: 1.6;
    font-size: 0.9em;
    backdrop-filter: blur(5px);
    box-shadow: 0 0 5px rgba(0,0,0,0.2);
}

.message.user-message {
    justify-content: flex-end;
}

.message.user-message .message-bubble {
    background: rgba(120,160,200,0.15);
    border: 1px solid rgba(100,140,200,0.3);
    color: #d9e7ff;
    border-bottom-right-radius: 4px;
}

.message.bot-message .message-bubble {
    background: rgba(250,240,200,0.1);
    border: 1px solid rgba(255,215,120,0.3);
    color: #f0e0b6;
    border-bottom-left-radius: 4px;
}

/* 入力エリア */
.chat-input-area {
    display: flex;
    align-items: center;
    padding: 8px;
    background: rgba(25,25,30,0.95);
    border-top: 1px solid rgba(255,255,255,0.05);
    flex-shrink: 0;
}

#messageInput {
    flex-grow: 1;
    border: 1px solid rgba(200,200,200,0.2);
    border-radius: 25px;
    padding: 10px 14px;
    font-size: 0.95em;
    background: rgba(255,255,255,0.08);
    color: #fff;
    outline: none;
}

#messageInput::placeholder {
    color: #aaa;
}

#sendMessageButton {
    background: linear-gradient(135deg, #a87932, #c49a4d);
    color: #fff;
    border: none;
    border-radius: 25px;
    padding: 10px 16px;
    margin-left: 8px;
    font-weight: bold;
    font-size: 0.9em;
    cursor: pointer;
    transition: 0.3s;
    flex-shrink: 0;
}

#sendMessageButton:hover {
    background: linear-gradient(135deg, #c49a4d, #e0b962);
}

/* フッター */
.chat-footer {
    background: rgba(10,10,15,0.9);
    color: #888;
    padding: 6px 10px;
    text-align: center;
    font-size: 0.7em;
    border-top: 1px solid rgba(255,255,255,0.05);
}

/* スクロールバー（軽量） */
.chat-messages::-webkit-scrollbar {
    width: 5px;
}
.chat-messages::-webkit-scrollbar-thumb {
    background: rgba(160,120,50,0.7);
    border-radius: 4px;
}

/* モバイル最適化 */
@media (max-width: 768px) {
    html, body {
        height: 100%;
        overflow: hidden;
    }

    .chat-container {
        height: 100vh;
        width: 100vw;
        border: none;
        border-radius: 0;
        box-shadow: none;
    }

    .chat-messages {
        padding: 8px;
    }

    .avatar {
        width: 30px;
        height: 30px;
        font-size: 0.8em;
    }

    .message-bubble {
        max-width: 85%;
        padding: 8px 12px;
        font-size: 0.85em;
    }

    #messageInput {
        font-size: 0.85em;
        padding: 8px 12px;
    }

    #sendMessageButton {
        padding: 8px 12px;
        font-size: 0.85em;
    }
}


    </style>
    </head>
<body>
    
    <div class="chat-container">
        <header class="chat-header">
            <h1>高田保馬 AI対話システム</h1>
        </header>
        
        <div class="chat-messages" id="chatMessages">
            <div class="message bot-message">
                <div class="avatar">高田保馬</div>
                <div class="message-bubble">
                    <p>私（わたくし）は高田保馬だ。何か学術的な問いかね？</p>
                    <p class="timestamp">...</p> </div>
            </div>
        </div>
        
        <div class="chat-input-area">
            <textarea id="messageInput" placeholder="質問を入力してください..." rows="3"></textarea>
            <button id="sendMessageButton">送信</button>
        </div>
        
        <footer class="chat-footer">
            <p>&copy; 2025池田悠耶ー開発 (Powered by Gemini)</p>
        </footer>
    </div>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const messageInput = document.getElementById('messageInput');
            const sendMessageButton = document.getElementById('sendMessageButton');
            const chatMessages = document.getElementById('chatMessages');

            sendMessageButton.addEventListener('click', sendMessage);
            messageInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { // Shift+Enterで改行、Enterのみで送信
                    e.preventDefault(); // デフォルトのEnterによる改行を防ぐ
                    sendMessage();
                }
            });

            // タイムスタンプを生成するヘルパー関数
            function getCurrentTimestamp() {
                const now = new Date();
                return now.toLocaleDateString('ja-JP') + ' ' + now.toLocaleTimeString('ja-JP', { hour: '2-digit', minute: '2-digit' });
            }

            // ページロード時の最初の挨拶メッセージのタイムスタンプを更新
            const firstTimestamp = document.querySelector('.message.bot-message .timestamp');
            if (firstTimestamp) {
                firstTimestamp.textContent = getCurrentTimestamp();
            }

            // メッセージ送信処理 (本番のfetchを使用)
            async function sendMessage() {
                const text = messageInput.value.trim();
                if (text === '') return;

                // 1. ユーザーメッセージを画面に追加
                appendMessage(text, 'user');
                messageInput.value = ''; // 入力欄をクリア
                messageInput.disabled = true; // 返信が来るまで入力を無効化
                sendMessageButton.disabled = true; // ボタンも無効化

                // "思考中..." のローディング表示を追加
                const loadingMessage = appendMessage('...', 'bot', true); // 'true'はローディング中フラグ


                try {
                    // 2. バックエンド(app.py)の /chat エンドポイントにリクエストを送信
                    const response = await fetch('/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: text }), // メッセージをJSON形式で送信
                    });

                    if (!response.ok) {
                        // サーバー側でエラーが発生した場合
                        throw new Error(`サーバーエラー: ${response.statusText}`);
                    }

                    const data = await response.json();

                    // 3. サーバーからの返信 (data.reply) を表示
                    // ローディング表示を削除
                    chatMessages.removeChild(loadingMessage);
                    
                    if (data.reply) {
                        // 改行を <br> に変換して表示
                        const formattedReply = data.reply.replace(/\n/g, '<br>');
                        appendMessage(formattedReply, 'bot');
                    } else if (data.error) {
                        appendMessage(`エラー: ${data.error}`, 'bot');
                    }

                } catch (error) {
                    // ネットワークエラーなど
                    chatMessages.removeChild(loadingMessage); // ローディング表示を削除
                    appendMessage(`通信エラーが発生しました: ${error.message}`, 'bot');
                } finally {
                    // 4. 入力欄を再度有効化
                    messageInput.disabled = false;
                    sendMessageButton.disabled = false;
                    messageInput.focus(); // 入力欄にフォーカスを戻す
                }
            }

            // メッセージを画面に追加する関数
            function appendMessage(text, sender, isLoading = false) {
                const messageDiv = document.createElement('div');
                messageDiv.classList.add('message', `${sender}-message`);

                const avatarDiv = document.createElement('div');
                avatarDiv.classList.add('avatar');
                avatarDiv.textContent = sender === 'user' ? 'あなた' : '高田保馬';

                const bubbleDiv = document.createElement('div');
                bubbleDiv.classList.add('message-bubble');

                if (isLoading) {
                    bubbleDiv.innerHTML = `<p class="loading-dots"><span>.</span><span>.</span><span>.</span></p>`;
                    messageDiv.classList.add('loading'); // ローディング専用CSSのため
                } else {
                    bubbleDiv.innerHTML = `<p>${text}</p>`; // innerHTMLを使い、<br>を解釈させる
                    const timestampDiv = document.createElement('p'); // pタグに変更
                    timestampDiv.classList.add('timestamp');
                    timestampDiv.textContent = getCurrentTimestamp();
                    bubbleDiv.appendChild(timestampDiv);
                }

                messageDiv.appendChild(avatarDiv);
                messageDiv.appendChild(bubbleDiv);
                chatMessages.appendChild(messageDiv);

                // チャット画面を一番下までスクロール
                chatMessages.scrollTop = chatMessages.scrollHeight;

                return messageDiv; // ローディング表示を消すために要素を返す
            }
        });
    </script>
    </body>
</html>